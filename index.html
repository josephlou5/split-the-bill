<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- Meta tags for Bootstrap -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />

    <!-- Bootstrap icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <style>
      .dollar-input {
        min-width: 3.5em !important;
        max-width: 5em;
      }

      #tip-percentage-input {
        min-width: 3em !important;
      }

      #add-person-input,
      #add-item-input {
        min-width: 7em;
      }
    </style>

    <title>Split the Bill</title>
  </head>

  <body>
    <div class="p-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">Home</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Split the Bill
          </li>
        </ol>
      </nav>

      <div>
        <span class="h1">Split the Bill</span>
        <span class="h6 fst-italic text-black text-opacity-50 ms-1">
          (<a href="changelog.html" class="text-reset">v0.3</a>)
        </span>
      </div>

      <div class="mb-3">
        <button type="button" id="reset-btn" class="btn btn-danger">
          Reset
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle w-auto">
          <thead>
            <tr>
              <th></th>
              <th></th>
              <th>Paid</th>
              <th class="summary-unpaid-column d-none">Unpaid</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th scope="row">Items Total</th>
              <td id="items-total">$0.00</td>
              <td id="items-total-paid">$0.00</td>
              <td
                id="items-total-unpaid"
                class="summary-unpaid-column text-center d-none"
              ></td>
            </tr>
            <tr>
              <th scope="row">
                <label for="tax-input" class="col-form-label">Tax</label>
              </th>
              <td id="tax">
                <div class="input-group flex-nowrap">
                  <span class="input-group-text">$</span>
                  <input
                    type="text"
                    inputmode="decimal"
                    pattern="[0-9]*"
                    id="tax-input"
                    class="form-control dollar-input"
                    value="0.00"
                    aria-label="Tax"
                  />
                </div>
              </td>
              <!-- these two columns just used as placeholder -->
              <td></td>
              <td class="summary-unpaid-column d-none"></td>
            </tr>
            <tr>
              <th scope="row">Tip</th>
              <td>
                <span id="total-tip" class="d-none">0.00</span>
                <div class="row align-items-center gx-2 mb-1">
                  <div class="col">
                    <div class="row align-items-center gx-2">
                      <div class="col-auto">
                        <div class="input-group flex-nowrap">
                          <div class="input-group-text">
                            <input
                              type="radio"
                              id="tip-with-percentage"
                              class="form-check-input mt-0"
                              name="tip"
                              aria-label="Use tip with percentage"
                              checked
                            />
                          </div>
                          <input
                            type="text"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            id="tip-percentage-input"
                            class="form-control"
                            value="15"
                            aria-label="Tip percentage"
                            size="2"
                          />
                          <span class="input-group-text">%</span>
                        </div>
                      </div>
                      <div class="col-auto">
                        <div class="form-check">
                          <input
                            type="checkbox"
                            id="include-tax-checkbox"
                            class="form-check-input"
                            aria-label="Include tax in total"
                          />
                          <label
                            for="include-tax-checkbox"
                            class="form-check-label"
                          >
                            With Tax
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-auto text-end">
                    =
                    <span id="tip-total-with-percentage" class="fw-bold">
                      $0.00
                    </span>
                  </div>
                </div>
                <div class="row align-items-center">
                  <div class="col">
                    <div class="input-group flex-nowrap">
                      <div class="input-group-text">
                        <input
                          type="radio"
                          id="tip-with-dollars"
                          class="form-check-input mt-0"
                          name="tip"
                          aria-label="Use tip with given dollars"
                        />
                      </div>
                      <span class="input-group-text">$</span>
                      <input
                        type="text"
                        inputmode="decimal"
                        pattern="[0-9]*"
                        id="tip-dollars-input"
                        class="form-control dollar-input"
                        value="0.00"
                        aria-label="Tip (dollars)"
                      />
                    </div>
                  </div>
                  <div class="col-auto text-end">
                    =
                    <span id="tip-total-with-dollars">$0.00</span>
                  </div>
                </div>
              </td>
              <!-- these two columns just used as placeholder -->
              <td></td>
              <td class="summary-unpaid-column d-none"></td>
            </tr>
            <tr>
              <th scope="row">Split Tax/Tip</th>
              <td>
                <div class="form-check form-check-inline">
                  <input
                    type="radio"
                    id="split-tax-tip-evenly"
                    class="form-check-input"
                    name="split-tax-tip"
                    aria-label="Split tax and tip evenly"
                    checked
                  />
                  <label class="form-check-label" for="split-tax-tip-evenly">
                    Evenly
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input
                    type="radio"
                    id="split-tax-tip-proportionally"
                    class="form-check-input"
                    name="split-tax-tip"
                    aria-label="Split tax and tip proportionally"
                  />
                  <label
                    class="form-check-label"
                    for="split-tax-tip-proportionally"
                  >
                    Proportionally
                  </label>
                </div>
              </td>
              <td id="tax-tip-paid">$0.00</td>
              <td
                id="tax-tip-unpaid"
                class="summary-unpaid-column text-center d-none"
              ></td>
            </tr>
            <tr>
              <th scope="row">Bill Total</th>
              <th id="bill-total">$0.00</th>
              <th id="bill-total-paid">$0.00</th>
              <th
                id="bill-total-unpaid"
                class="summary-unpaid-column text-center d-none"
              ></th>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle w-auto">
          <thead class="align-middle">
            <tr>
              <th></th>
              <th colspan="3" class="text-end">
                People
                <span class="fw-normal">(<span id="num-people">0</span>)</span>
              </th>
              <th id="add-person-col">
                <div class="input-group flex-nowrap">
                  <input
                    type="text"
                    id="add-person-input"
                    class="form-control"
                    aria-label="Name"
                    aria-describedby="add-person-btn"
                    placeholder="Add person"
                    size="15"
                  />
                  <button
                    type="button"
                    id="add-person-btn"
                    class="btn btn-sm btn-success"
                  >
                    <i class="bi bi-plus-lg"></i>
                  </button>
                </div>
              </th>
            </tr>
            <tr id="items-per-person-row">
              <th></th>
              <th colspan="3" class="text-end">Items Price</th>
            </tr>
            <tr id="tax-tip-per-person-row">
              <th></th>
              <th colspan="3" class="text-end">Tax/Tip Price</th>
            </tr>
            <tr id="total-per-person-row">
              <th></th>
              <th colspan="3" class="text-end">Total Price</th>
            </tr>
            <tr id="toggle-person-row">
              <td></td>
              <th>
                Items
                <span class="fw-normal">(<span id="num-items">0</span>)</span>
              </th>
              <th class="text-center">
                <span id="item-unpaid-column-label" class="d-none">Unpaid</span>
              </th>
              <td></td>
            </tr>
          </thead>
          <tbody>
            <tr id="add-item-row">
              <td></td>
              <td>
                <div class="input-group flex-nowrap">
                  <input
                    type="text"
                    id="add-item-input"
                    class="form-control"
                    aria-label="Item"
                    aria-describedby="add-item-btn"
                    placeholder="Add item"
                    size="15"
                  />
                  <button
                    type="button"
                    id="add-item-btn"
                    class="btn btn-sm btn-success"
                  >
                    <i class="bi bi-plus-lg"></i>
                  </button>
                </div>
              </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="text-secondary" style="font-size: 0.8em">
        See the source code at
        <a href="https://github.com/josephlou5/split-the-bill" target="_blank"
          >https://github.com/josephlou5/split-the-bill</a
        >.
      </div>
    </div>

    <!-- Bootstrap JS (Popper not needed) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"
      integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ"
      crossorigin="anonymous"
    ></script>

    <!-- JQuery -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>

    <script>
      const SUMMARY_UNPAID_COLUMN_CLASS = 'summary-unpaid-column';

      const PERSON_COL_CLASS = 'person-col';
      const PERSON_ITEM_PRICE_CLASS = 'person-item-price';
      const PERSON_TAX_TIP_PRICE_CLASS = 'person-tax-tip-price';
      const PERSON_TOTAL_PRICE_CLASS = 'person-total-price';

      const ITEM_ROW_CLASS = 'item-row';
      const ITEM_PRICE_INPUT_CLASS = 'item-price-input';

      const CHECKBOX_CELL_CLASS = 'checkbox-cell';
      const CHECKBOX_CLASS = 'checkbox';

      let personCounter = 0;
      let itemCounter = 0;

      function divmod(dividend, divisor) {
        dividend = Math.round(dividend);
        const quotient = Math.trunc(dividend / divisor);
        const rem = dividend - divisor * quotient;
        return [quotient, rem];
      }

      function getVal($input) {
        return $input.val()?.trim() ?? '';
      }

      function getInts(string, defaultValue = 0) {
        const stripped = string.replace(/\D/g, '');
        if (stripped === '') return defaultValue;
        return parseInt(stripped);
      }

      function getDollarVal($input) {
        return getInts(getVal($input)) / 100;
      }

      function getPercentageVal($input) {
        return getInts(getVal($input)) % 100;
      }

      function roundDollars(dollars) {
        const ROUND_UP = 1e-5;
        let dollarsTrunc = Math.trunc(dollars * 100);
        if (Math.trunc((dollars + ROUND_UP) * 100) > dollarsTrunc) {
          dollarsTrunc += 1;
        }
        return dollarsTrunc / 100;
      }

      function dollarStr(dollars, dollarSign = false) {
        // round to two decimal places
        return (dollarSign ? '$' : '') + dollars.toFixed(2);
      }

      function makeBsBadge(accent, text) {
        return `<span class="badge bg-${accent}">${text}</span>`;
      }

      function updateSummary() {
        console.groupCollapsed('updating summary...');

        // get people
        const personIds = [];
        $(`.${PERSON_COL_CLASS}`).each((index, element) => {
          const personId = element.id;
          personIds.push(personId);
        });
        console.group('people');
        console.log('num people:', personIds.length);
        console.log('ids:', personIds);
        console.groupEnd('people');

        // get items
        const itemIds = [];
        const checked = {}; // initialize checked
        $(`.${ITEM_ROW_CLASS}`).each((index, element) => {
          const itemId = element.id;
          itemIds.push(itemId);
          checked[itemId] = [];
        });

        // get costs for each item
        let totalItemCost = 0;
        const itemCosts = {};
        $(`.${ITEM_PRICE_INPUT_CLASS}`).each((index, element) => {
          const $input = $(element);
          const itemId = $input.attr('item');
          const price = getDollarVal($input);
          totalItemCost += price;
          itemCosts[itemId] = price;
        });
        // update total item cost
        $('#items-total').text(dollarStr(totalItemCost, true));

        console.group('items');
        console.log('num items:', itemIds.length);
        console.log('ids:', itemIds);
        console.log('costs:', itemCosts);
        console.log('total cost:', totalItemCost);
        console.groupEnd('items');

        console.group('globals');

        // find tax amount
        const $taxInput = $('#tax-input');
        const tax = getDollarVal($taxInput);
        $taxInput.toggleClass(
          'border-danger',
          (itemIds.length > 0 || personIds.length > 0) && tax === 0
        );
        console.log('tax:', tax);

        // update total tip with percentage
        console.group('tip with percentage');
        const includeTax = $('#include-tax-checkbox').prop('checked');
        console.log('include tax:', includeTax);
        const itemsAndTaxTotal = roundDollars(
          totalItemCost + (includeTax ? tax : 0)
        );
        const tipPercentage =
          getPercentageVal($('#tip-percentage-input')) / 100;
        console.log('percentage:', tipPercentage);
        const totalTipWithPercentage = roundDollars(
          itemsAndTaxTotal * tipPercentage
        );
        $('#tip-total-with-percentage').text(
          dollarStr(totalTipWithPercentage, true)
        );
        if (includeTax) {
          console.log(
            'total tip with percentage:',
            `(${totalItemCost} + ${tax}) * ${
              tipPercentage * 100
            }% = ${totalTipWithPercentage}`
          );
        } else {
          console.log(
            'total tip with percentage:',
            `${totalItemCost} * ${
              tipPercentage * 100
            }% = ${totalTipWithPercentage}`
          );
        }
        console.groupEnd('tip with percentage');
        // update total tip with dollars
        console.group('tip with dollars');
        const totalTipWithDollars = getDollarVal($('#tip-dollars-input'));
        $('#tip-total-with-dollars').text(dollarStr(totalTipWithDollars, true));
        console.log('total tip with dollars:', totalTipWithDollars);
        console.groupEnd('tip with dollars');
        // update total tip
        const tipWithPercentage = $('#tip-with-percentage').prop('checked');
        let totalTip;
        if (tipWithPercentage) {
          totalTip = totalTipWithPercentage;
          $('#tip-total-with-percentage').addClass('fw-bold');
          $('#tip-total-with-dollars').removeClass('fw-bold');
          console.log('tip with percentage selected; total tip:', totalTip);
        } else {
          totalTip = totalTipWithDollars;
          $('#tip-total-with-percentage').removeClass('fw-bold');
          $('#tip-total-with-dollars').addClass('fw-bold');
          console.log('tip with dollars selected; total tip:', totalTip);
        }
        $('#total-tip').text(dollarStr(totalTip));

        const totalTaxTip = roundDollars(tax + totalTip);
        console.log(
          'tax + tip total:',
          `${tax} + ${totalTip} = ${totalTaxTip}`
        );

        // update bill total
        const billTotal = roundDollars(totalItemCost + totalTaxTip);
        $('#bill-total').text(dollarStr(billTotal, true));
        console.log(
          'bill total:',
          `${totalItemCost} + ${tax} + ${totalTip} = ${billTotal}`
        );
        console.groupEnd('globals');

        // find out who is checked for each item
        $(`.${CHECKBOX_CLASS}`).each((index, element) => {
          const $button = $(element);
          const isChecked = $button.prop('checked');
          if (!isChecked) return;
          const itemId = $button.attr('item');
          const personId = $button.attr('person');
          checked[itemId].push(personId);
        });
        console.log('checked:', checked);

        // calculate the amount per person for each item
        console.groupCollapsed('calculating price per item');
        const itemPricePerPerson = {};
        for (const personId of personIds) {
          itemPricePerPerson[personId] = 0;
        }
        let anyUnpaid = false;
        for (const [itemId, payingPeople] of Object.entries(checked)) {
          console.group(itemId);

          const $unpaid = $(`#${itemId}-unpaid`);
          $unpaid.html('');
          const $price = $(`#${itemId}-price`);
          $price.removeClass('border-danger');

          const itemCost = itemCosts[itemId];
          if (itemCost === 0) {
            if (payingPeople.length > 0) {
              // people are paying, but no price
              console.log('no price, but people checked');
              $price.addClass('border-danger');
            } else {
              console.log('no price');
            }
            console.groupEnd(itemId);
            continue;
          }
          if (payingPeople.length === 0) {
            // no one is paying for this item
            console.log('no people checked');
            anyUnpaid = true;
            $unpaid.html(makeBsBadge('danger', dollarStr(itemCost, true)));
            console.groupEnd(itemId);
            continue;
          }
          console.log('people checked:', payingPeople);

          // calculate how much each person should pay
          const [centsPerPerson, centsLeftOver] = divmod(
            itemCost * 100,
            payingPeople.length
          );
          const perPerson = centsPerPerson / 100;
          console.log(
            'price per person:',
            `${itemCost} / ${payingPeople.length} people = ${perPerson}`
          );
          for (const personId of payingPeople) {
            itemPricePerPerson[personId] += perPerson;
          }
          if (centsLeftOver > 0) {
            // some leftover cost that no one is paying for
            console.log('left over cost:', centsLeftOver / 100);
            anyUnpaid = true;
            $unpaid.html(
              makeBsBadge('danger', dollarStr(centsLeftOver / 100, true))
            );
          }

          console.groupEnd(itemId);
        }
        // if there are any unpaid items, show the label; otherwise, hide it
        $(`#item-unpaid-column-label`).toggleClass('d-none', !anyUnpaid);
        console.groupEnd('calculating amount per item');

        // update the people's item prices
        let totalItemsPaid = 0;
        $(`.${PERSON_ITEM_PRICE_CLASS}`).each((index, element) => {
          const $element = $(element);
          const personId = $element.attr('person');
          const personItemPrice = roundDollars(
            itemPricePerPerson[personId] ?? 0
          );
          itemPricePerPerson[personId] = personItemPrice;
          $element.text(dollarStr(personItemPrice, true));
          // if the person is not paying anything for items
          $element.toggleClass(
            'text-warning',
            totalItemCost > 0 && personItemPrice === 0
          );
          totalItemsPaid += personItemPrice;
        });
        console.log('item price per person:', itemPricePerPerson);

        // calculate the tax/tip prices per person
        console.groupCollapsed('calculating tax/tip price per person');
        const splitTaxTipEvenly = $('#split-tax-tip-evenly').prop('checked');
        const taxTipPricePerPerson = {};
        let totalTaxTipPaid;
        let totalTaxTipUnpaid;
        if (splitTaxTipEvenly) {
          console.log('splitting tax/tip evenly');
          if (personIds.length === 0) {
            // no people, so all tax/tip is unpaid
            console.log('no people');
            totalTaxTipUnpaid = totalTaxTip;
          } else {
            const [centsPerPerson, centsLeftOver] = divmod(
              totalTaxTip * 100,
              personIds.length
            );
            const taxTipPerPerson = roundDollars(centsPerPerson / 100);
            console.log(
              'tax/tip per person:',
              `${totalTaxTip} / ${personIds.length} people = ${taxTipPerPerson}`
            );
            for (const personId of personIds) {
              taxTipPricePerPerson[personId] = taxTipPerPerson;
            }
            totalTaxTipUnpaid = roundDollars(centsLeftOver / 100);
          }
          totalTaxTipPaid = roundDollars(totalTaxTip - totalTaxTipUnpaid);
        } else {
          // split proportionally
          console.log('splitting tax/tip proportionally');
          totalTaxTipPaid = 0;
          console.log('total items paid:', totalItemsPaid);
          if (totalItemsPaid > 0) {
            for (const [personId, personItemPrice] of Object.entries(
              itemPricePerPerson
            )) {
              console.group(personId);
              const proportion = personItemPrice / totalItemsPaid;
              console.log(
                'proportion:',
                `${personItemPrice} / ${totalItemsPaid} = ${proportion}`
              );
              let personTaxTipPrice;
              if (proportion === 0) {
                personTaxTipPrice = 0;
              } else if (proportion === 1) {
                personTaxTipPrice = totalTaxTip;
              } else {
                personTaxTipPrice = roundDollars(proportion * totalTaxTip);
              }
              console.log(
                'tax/tip contribution:',
                `${totalTaxTip} * ${proportion * 100}% = ${personTaxTipPrice}`
              );
              taxTipPricePerPerson[personId] = personTaxTipPrice;
              totalTaxTipPaid += personTaxTipPrice;
              console.groupEnd(personId);
            }
          } else {
            console.log("no one has paid for items, so can't split tax/tip");
          }
          totalTaxTipPaid = roundDollars(totalTaxTipPaid);
          totalTaxTipUnpaid = roundDollars(totalTaxTip - totalTaxTipPaid);
        }
        console.log('tax/tip paid:', totalTaxTipPaid);
        console.log('tax/tip unpaid:', totalTaxTipUnpaid);
        console.groupEnd('calculating tax/tip price per person');

        // update the people's tax/tip prices
        $(`.${PERSON_TAX_TIP_PRICE_CLASS}`).each((index, element) => {
          const $element = $(element);
          const personId = $element.attr('person');
          const personTaxTipPrice = roundDollars(
            taxTipPricePerPerson[personId] ?? 0
          );
          taxTipPricePerPerson[personId] = personTaxTipPrice;
          $element.text(dollarStr(personTaxTipPrice, true));
        });
        console.log('tax/tip price per person:', taxTipPricePerPerson);

        // update the people's total price
        let totalPaid = 0;
        const totalPricePerPerson = {};
        $(`.${PERSON_TOTAL_PRICE_CLASS}`).each((index, element) => {
          const $element = $(element);
          const personId = $element.attr('person');
          const personTotalPrice = roundDollars(
            (itemPricePerPerson[personId] ?? 0) +
              (taxTipPricePerPerson[personId] ?? 0)
          );
          totalPricePerPerson[personId] = personTotalPrice;
          $element.text(dollarStr(personTotalPrice, true));
          // if the price is 0, make the text red
          $element.toggleClass('text-danger', personTotalPrice === 0);
          totalPaid += personTotalPrice;
        });
        console.log('total price per person:', totalPricePerPerson);

        // update summary totals
        let anyTotalUnpaid = false;
        const summaryTotals = {};
        for (const [idPrefix, paid, unpaid] of [
          [
            'items-total',
            totalItemsPaid,
            roundDollars(totalItemCost - totalItemsPaid),
          ],
          ['tax-tip', totalTaxTipPaid, totalTaxTipUnpaid],
          ['bill-total', totalPaid, roundDollars(billTotal - totalPaid)],
        ]) {
          summaryTotals[idPrefix] = { paid, unpaid };
          $(`#${idPrefix}-paid`).text(dollarStr(paid, true));
          if (unpaid === 0) {
            $(`#${idPrefix}-unpaid`).html('');
          } else {
            anyTotalUnpaid = true;
            $(`#${idPrefix}-unpaid`).html(
              makeBsBadge('danger', dollarStr(unpaid, true))
            );
          }
        }
        // if there are any unpaid totals, show the column; otherwise, hide it
        $(`.${SUMMARY_UNPAID_COLUMN_CLASS}`).toggleClass(
          'd-none',
          !anyTotalUnpaid
        );
        console.group('summary totals');
        console.table(summaryTotals);
        console.groupEnd('summary totals');

        console.groupEnd();
      }

      function updateDollarValue(element) {
        const $input = $(element);
        $input.val(dollarStr(getDollarVal($input)));
        updateSummary();
      }

      function updatePercentageValue(element) {
        const $input = $(element);
        $input.val(getPercentageVal($input));
        updateSummary();
      }

      function makeDeleteButton(attr, id, classes = '') {
        const attrTitle =
          attr.charAt(0).toUpperCase() + attr.slice(1).toLowerCase();
        return `
          <button
            type="button"
            class="btn btn-sm btn-danger ${classes}"
            onclick="handleDelete${attrTitle}Clicked('${id}');"
          >
            <i class="bi bi-x-lg"></i>
          </button>`;
      }

      function makeEntireToggleButton(attr, id) {
        return `
          <td
            class="text-center ${id}"
            onclick="handleEntireToggle('${attr}', '${id}');"
          >
            <button type="button" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-toggles"></i>
            </button>
          </td>`;
      }

      function makePersonNameCell(personId) {
        return `
          <td
            id="${personId}"
            class="${PERSON_COL_CLASS} ${personId} text-center"
          >
            <div class="d-flex align-items-center">
              <div id="${personId}-label" class="w-100"></div>
              <div class="w-auto ms-1">
                ${makeDeleteButton('person', personId, 'ms-1')}
              </div>
            </div>
          </td>`;
      }

      function makePersonItemPriceCell(personId) {
        return `
          <td
            class="${PERSON_ITEM_PRICE_CLASS} ${personId} text-center"
            person="${personId}"
          >
            $0.00
          </td>`;
      }

      function makePersonTaxTipPriceCell(personId) {
        return `
          <td
            class="${PERSON_TAX_TIP_PRICE_CLASS} ${personId} text-center"
            person="${personId}"
          >
            $0.00
          </td>`;
      }

      function makePersonTotalPriceCell(personId) {
        return `
          <td
            class="${PERSON_TOTAL_PRICE_CLASS} ${personId} text-center fw-bold"
            person="${personId}"
          >
            $0.00
          </td>`;
      }

      function makeDeleteItemCell(itemId) {
        return `<td>${makeDeleteButton('item', itemId)}</td>`;
      }

      function makeItemLabelCells(itemId) {
        return `
          <td>
            <div class="row align-items-center gx-2 gy-1">
              <div id="${itemId}-label" class="col"></div>
              <div class="col-auto">
                <div class="input-group flex-nowrap">
                  <span class="input-group-text">$</span>
                  <input
                    type="text"
                    inputmode="decimal"
                    id="${itemId}-price"
                    item="${itemId}"
                    class="form-control dollar-input ${ITEM_PRICE_INPUT_CLASS}"
                    value="0.00"
                    oninput="updateDollarValue(this);"
                    aria-label="Item Price"
                  />
                </div>
            </div>
          </td>`;
      }

      function makeItemUnpaidCell(itemId) {
        return `<td id="${itemId}-unpaid" class="text-center"></td>`;
      }

      function makeCheckboxCellHtml(itemId, personId) {
        const id = `${itemId}-${personId}-checkbox`;
        const uncheckedClass = `${itemId}-${personId}-unchecked`;
        const checkedClass = `${itemId}-${personId}-checked`;
        return `
          <td class="text-center ${personId}">
            <button
              type="button"
              id="${id}"
              item="${itemId}"
              person="${personId}"
              class="btn btn-outline-danger ${CHECKBOX_CLASS} w-100 h-100"
              onclick="handleCheckboxToggled(this);"
            >
              <i id="${uncheckedClass}" class="bi bi-x"></i>
              <i id="${checkedClass}" class="bi bi-check-lg d-none"></i>
            </button>
          </td>`;
      }

      function handleDeletePersonClicked(personId) {
        const name = $(`#${personId}-label`).text();
        if (!confirm(`Are you sure you want to remove person "${name}"?`))
          return;
        $(`.${personId}`).remove();
        // update the number
        $('#num-people').text($(`.${PERSON_COL_CLASS}`).length);
        updateSummary();
      }

      function handleDeleteItemClicked(itemId) {
        const item = $(`#${itemId}-label`).text();
        if (!confirm(`Are you sure you want to remove item "${item}"?`)) return;
        $(`#${itemId}`).remove();
        // update the number
        $('#num-items').text($(`.${ITEM_ROW_CLASS}`).length);
        updateSummary();
      }

      function setCheckbox($button, checked) {
        const isChecked = $button.prop('checked');
        if (isChecked === checked) return;

        const itemId = $button.attr('item');
        const personId = $button.attr('person');
        const $checked = $(`#${itemId}-${personId}-checked`);
        const $unchecked = $(`#${itemId}-${personId}-unchecked`);

        if (checked) {
          // make it checked
          $button.addClass('btn-success').removeClass('btn-outline-danger');
          $button.prop('checked', true);
          $unchecked.addClass('d-none');
          $checked.removeClass('d-none');
        } else {
          // make it unchecked
          $button.addClass('btn-outline-danger').removeClass('btn-success');
          $button.prop('checked', false);
          $checked.addClass('d-none');
          $unchecked.removeClass('d-none');
        }
      }

      function handleEntireToggle(attr, id) {
        const attrLower = attr.toLowerCase();
        const $buttons = $(`.${CHECKBOX_CLASS}[${attrLower}="${id}"]`);
        if ($buttons.length === 0) return;

        // check if all checkboxes are currently toggled
        let allChecked = true;
        $buttons.each((index, element) => {
          const $button = $(element);
          if (!$button.prop('checked')) {
            allChecked = false;
            return false;
          }
        });

        // toggle all checkboxes
        $buttons.each((index, element) => {
          const $button = $(element);
          // if everything is checked, uncheck everything
          // otherwise, check everything
          setCheckbox($button, !allChecked);
        });

        updateSummary();
      }

      function handleCheckboxToggled(element) {
        const $button = $(element);
        const isChecked = $button.prop('checked');
        setCheckbox($button, !isChecked);
        updateSummary();
      }

      function onInput(inputId, buttonId, callback) {
        const ENTER_KEY = 13;
        $(inputId).on('keypress', (event) => {
          if (event.which === ENTER_KEY) {
            callback($(inputId), $(buttonId));
          }
        });
        $(buttonId).click((event) => {
          callback($(inputId), $(buttonId));
        });
      }

      function handleAddPerson(name) {
        if (name === '') return null;

        const personId = `person${personCounter++}`;

        // add the column
        $('#add-person-col').before(makePersonNameCell(personId));
        // set the text of the person's name (escaped)
        $(`#${personId}-label`).text(name);

        // person's item price
        $('#items-per-person-row').append(makePersonItemPriceCell(personId));
        // person's tax/tip price
        $('#tax-tip-per-person-row').append(
          makePersonTaxTipPriceCell(personId)
        );
        // person's total price
        $('#total-per-person-row').append(makePersonTotalPriceCell(personId));

        // toggle entire person
        $('#toggle-person-row').append(
          makeEntireToggleButton('person', personId)
        );

        // add the checkboxes to each item row
        $(`.${ITEM_ROW_CLASS}`).each((index, element) => {
          const itemId = element.id;
          $(element).append(makeCheckboxCellHtml(itemId, personId));
        });

        // add one more cell to the add item row
        $('#add-item-row').append(`<td class="${personId}"></td>`);

        // update the number of people
        $('#num-people').text($(`.${PERSON_COL_CLASS}`).length);

        updateSummary();

        return personId;
      }

      function handleAddItem(item) {
        if (item === '') return null;

        const itemId = `item${itemCounter++}`;

        const cells = [];
        // delete item button
        cells.push(makeDeleteItemCell(itemId));
        // item label (will be populated later)
        cells.push(makeItemLabelCells(itemId));
        // unpaid amount
        cells.push(makeItemUnpaidCell(itemId));
        // toggle entire item
        cells.push(makeEntireToggleButton('item', itemId));
        // checkboxes
        $(`.${PERSON_COL_CLASS}`).each((index, element) => {
          const personId = element.id;
          cells.push(makeCheckboxCellHtml(itemId, personId));
        });

        // add the row
        const itemRow = $('<tr></tr>', {
          id: itemId,
          class: ITEM_ROW_CLASS,
        }).html(cells.join(''));
        $('#add-item-row').before(itemRow);

        // set the text of the item label (escaped)
        $(`#${itemId}-label`).text(item);

        // update the number of items
        $('#num-items').text($(`.${ITEM_ROW_CLASS}`).length);

        updateSummary();

        return itemId;
      }

      $(document).ready(() => {
        // reset button
        $('#reset-btn').click((event) => {
          if (
            $('#num-people').text().trim() !== '0' ||
            $('#num-items').text().trim() !== '0'
          ) {
            if (!confirm('Are you sure you want to reset the page?')) return;
          }
          // reset the page by reloading it
          location.reload();
        });

        // tax input
        $('#tax-input').on('input', (event) => {
          updateDollarValue(event.target);
        });

        // select tip type
        $('input[type="radio"][name="tip"]').on('input', (event) => {
          updateSummary();
        });
        // tip percentage
        $('#tip-percentage-input').on('input', (event) => {
          updatePercentageValue(event.target);
        });
        // include tax in tip total checkbox
        $('#include-tax-checkbox').on('input', (event) => {
          updateSummary();
        });
        // tip dollars
        $('#tip-dollars-input').on('input', (event) => {
          updateDollarValue(event.target);
        });

        // select split tax/tip type
        $('input[type="radio"][name="split-tax-tip"]').on('input', (event) => {
          updateSummary();
        });

        // adding a person
        onInput('#add-person-input', '#add-person-btn', ($input, $button) => {
          const name = getVal($input);
          handleAddPerson(name);
          // clear the input
          $input.val('');
        });

        // adding an item
        onInput('#add-item-input', '#add-item-btn', ($input, $button) => {
          const item = getVal($input);
          handleAddItem(item);
          // clear the input
          $input.val('');
        });
      });
    </script>
  </body>
</html>
